<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Document Management</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Carbon Design System inspired styles -->
    <style>
        :root {
            --carbon-gray-10: #f4f4f4;
            --carbon-gray-20: #e0e0e0;
            --carbon-gray-80: #393939;
            --carbon-gray-100: #161616;
            --carbon-blue-60: #0f62fe;
            --carbon-red-60: #da1e28;
            --carbon-green-60: #24a148;
        }

        body {
            background-color: var(--carbon-gray-10);
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--carbon-gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            border-radius: 4px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .login-card h3 {
            color: var(--carbon-gray-80);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .login-card .form-control {
            border-radius: 0;
            border: 1px solid var(--carbon-gray-20);
            padding: 0.75rem 1rem;
        }

        .login-card .form-control:focus {
            border-color: var(--carbon-blue-60);
            box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.2);
        }

        .login-card .btn-primary {
            background: var(--carbon-blue-60);
            border: none;
            border-radius: 0;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            width: 100%;
        }

        .login-card .btn-primary:hover {
            background: #0353e9;
        }

        .admin-content {
            display: none;
        }

        .sidebar {
            background: var(--carbon-gray-100);
            min-height: 100vh;
            padding: 0;
        }

        .sidebar .brand {
            padding: 1.5rem;
            border-bottom: 1px solid var(--carbon-gray-80);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .sidebar .nav-link {
            color: var(--carbon-gray-20);
            padding: 1rem 1.5rem;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: var(--carbon-gray-80);
            border-left-color: var(--carbon-blue-60);
        }

        .main-content {
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            color: var(--carbon-gray-100);
            font-weight: 600;
        }

        .stat-card {
            background: white;
            border-radius: 4px;
            padding: 1.5rem;
            border: 1px solid var(--carbon-gray-20);
            margin-bottom: 1rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--carbon-blue-60);
        }

        .stat-card .stat-label {
            color: var(--carbon-gray-80);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .table-card {
            background: white;
            border-radius: 4px;
            border: 1px solid var(--carbon-gray-20);
            overflow: hidden;
        }

        .table-card .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--carbon-gray-20);
            background: var(--carbon-gray-10);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-card .card-body {
            padding: 0;
        }

        .table {
            margin: 0;
        }

        .table th {
            background: var(--carbon-gray-10);
            border-bottom: 1px solid var(--carbon-gray-20);
            font-weight: 600;
            color: var(--carbon-gray-80);
            padding: 1rem 1.5rem;
        }

        .table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--carbon-gray-20);
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: var(--carbon-gray-10);
        }

        .btn-danger {
            background: var(--carbon-red-60);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-danger:hover {
            background: #b81921;
        }

        .btn-secondary {
            background: var(--carbon-gray-80);
            border: none;
            border-radius: 0;
        }

        .btn-secondary:hover {
            background: #262626;
        }

        .search-box {
            border-radius: 0;
            border: 1px solid var(--carbon-gray-20);
            padding: 0.5rem 1rem;
            width: 250px;
        }

        .search-box:focus {
            border-color: var(--carbon-blue-60);
            outline: none;
        }

        .alert {
            border-radius: 0;
            border: none;
        }

        .loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--carbon-gray-20);
            border-top-color: var(--carbon-blue-60);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            padding: 1.5rem;
            text-align: center;
            color: var(--carbon-gray-80);
            font-size: 0.875rem;
            border-top: 1px solid var(--carbon-gray-20);
            margin-top: 2rem;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--carbon-gray-80);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .drop-zone {
            border: 2px dashed var(--carbon-gray-20);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--carbon-blue-60);
            background: rgba(15, 98, 254, 0.02);
        }
    </style>
</head>
<body>
    <!-- Login Modal Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <h3>Admin Login</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                </div>
                <div class="alert alert-danger d-none" id="loginError"></div>
                <button type="submit" class="btn btn-primary">Sign In</button>

                <div class="credentials-info mt-3 p-3 bg-light rounded" style="background-color: #f8f9fa !important;">
                    <small class="text-muted d-block mb-2">Demo Credentials:</small>
                    <strong>Username:</strong> admin<br>
                    <strong>Password:</strong> Admin123
                </div>

                <div class="bot-info mt-3 p-3 rounded border" style="background-color: #e7f1ff !important; border-color: #b6d4fe !important;">
                    <small class="text-secondary">
                        <strong>Note:</strong> This bot is customized as a Bugema University assistant.
                        You can modify the AI persona in <code>gemini.js</code> to customize for other institutions.
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Content -->
    <div class="admin-content" id="adminContent">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar">
                    <div class="brand">
                        Admin Panel
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link" href="index.html">
                            Dashboard
                        </a>
                        <a class="nav-link" href="chat.html">
                            Chat
                        </a>
                        <a class="nav-link active" href="#" data-section="documents">
                            Documents
                        </a>
                    </nav>
                </div>

                <!-- Main Content -->
                <div class="col-md-10 main-content">
                    <!-- Documents Section -->
                    <div id="documentsSection">
                        <div class="page-header d-flex justify-content-between align-items-center">
                            <h1>Document Management</h1>
                            <button class="btn btn-secondary" onclick="loadDocuments()">
                                Refresh
                            </button>
                        </div>

                        <!-- Upload Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="drop-zone" id="dropZone">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 48px; height: 48px; color: var(--carbon-gray-80); margin-bottom: 1rem;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <h5>Upload PDF Document</h5>
                                    <p class="text-muted mb-0">Drag and drop or click to select</p>
                                    <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
                                </div>

                                <div id="uploadProgress" style="display: none;">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span id="uploadStatus">Processing...</span>
                                        <span id="uploadPercent">0%</span>
                                    </div>
                                    <div class="progress" style="height: 8px; border-radius: 4px; background: var(--carbon-gray-20);">
                                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; background: var(--carbon-blue-60);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Table -->
                        <div class="table-card">
                            <div class="card-header">
                                <h5 class="mb-0">Uploaded Documents</h5>
                                <input type="text" class="search-box" id="searchBox" placeholder="Search documents...">
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table" id="documentsTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Document Name</th>
                                                <th>Chunks</th>
                                                <th>Uploaded</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="documentsBody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="loading-spinner mx-auto"></div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div id="emptyState" class="empty-state d-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p>No documents found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="footer">
                        &copy; 2025 kitaroghope. All rights reserved.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 0;">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong id="deleteDocName"></strong>?</p>
                    <p class="text-danger mb-0">This will remove all <span id="deleteChunkCount"></span> chunks associated with this document. This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
        <div id="toast" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastBody"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // Admin credentials
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'Admin123';

        // State
        let documents = [];
        let documentToDelete = null;
        let deleteModal = null;
        let toast = null;
        let uploadInProgress = false;

        // Socket.IO
        const socket = io();

        // Initialize
        $(document).ready(function() {
            checkAuth();
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            toast = new bootstrap.Toast(document.getElementById('toast'));

            // Login form handler
            $('#loginForm').on('submit', handleLogin);

            // Search handler
            $('#searchBox').on('input', filterDocuments);

            // Delete confirmation
            $('#confirmDelete').on('click', confirmDelete);

            // File upload handlers
            initFileUpload();
        });

        // File Upload
        function initFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const pdfInput = document.getElementById('pdfInput');

            dropZone.addEventListener('click', () => pdfInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    uploadPDF(e.dataTransfer.files[0]);
                }
            });
            pdfInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadPDF(e.target.files[0]);
                }
            });
        }

        async function uploadPDF(file) {
            if (file.type !== 'application/pdf') {
                showToast('Please select a PDF file', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('pdf', file);

            document.getElementById('uploadProgress').style.display = 'block';
            uploadInProgress = true;

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed: ' + error.message, 'danger');
                document.getElementById('uploadProgress').style.display = 'none';
                uploadInProgress = false;
            }
        }

        // Socket events for upload progress
        socket.on('upload-progress', (progress) => {
            document.getElementById('progressBar').style.width = progress.percent + '%';
            document.getElementById('uploadPercent').textContent = progress.percent + '%';
            document.getElementById('uploadStatus').textContent = progress.message;
        });

        socket.on('upload-complete', () => {
            document.getElementById('uploadStatus').textContent = 'Upload complete!';
            document.getElementById('uploadPercent').textContent = '100%';
            uploadInProgress = false;
            showToast('Document uploaded successfully', 'success');
            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
            }, 2000);
            loadDocuments();
        });

        socket.on('upload-error', (error) => {
            document.getElementById('uploadStatus').textContent = 'Error: ' + error.error;
            uploadInProgress = false;
            showToast('Upload failed: ' + error.error, 'danger');
        });

        // Authentication
        function checkAuth() {
            const authenticated = sessionStorage.getItem('admin_authenticated');
            if (authenticated === 'true') {
                showAdminPanel();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = $('#username').val();
            const password = $('#password').val();
            const errorEl = $('#loginError');

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                sessionStorage.setItem('admin_authenticated', 'true');
                showAdminPanel();
                errorEl.addClass('d-none');
            } else {
                errorEl.text('Invalid username or password').removeClass('d-none');
            }
        }

        function showAdminPanel() {
            $('#loginOverlay').fadeOut(200, function() {
                $(this).remove();
                $('#adminContent').fadeIn(200);
                loadDocuments();
            });
        }

        // Document Management
        function loadDocuments() {
            $('#documentsBody').html('<tr><td colspan="5" class="text-center py-4"><div class="loading-spinner mx-auto"></div></td></tr>');

            $.ajax({
                url: '/api/documents',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('=== API Response ===');
                    console.log('Full response:', response);
                    console.log('Documents array:', response.documents);
                    console.log('Documents count:', response.documents?.length);

                    if (response.success) {
                        documents = response.documents || [];
                        console.log('=== Loaded Documents ===');
                        documents.forEach((doc, index) => {
                            console.log(`Doc ${index + 1}:`, {
                                id: doc.id,
                                filename: doc.filename,
                                upload_date: doc.upload_date,
                                text_length: doc.text_length,
                                chunk_count: doc.chunk_count,
                                // Also check for camelCase variants
                                uploadDate: doc.uploadDate,
                                textLength: doc.textLength,
                                chunkCount: doc.chunkCount
                            });
                        });
                        renderDocuments();
                    } else {
                        showToast('Failed to load documents', 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('=== AJAX Error ===');
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                    showToast('Error loading documents: ' + error, 'danger');
                }
            });
        }

        function renderDocuments() {
            console.log('=== Rendering Documents ===');
            console.log('Documents to render:', documents);
            const filtered = filterDocumentsList();
            const tbody = $('#documentsBody');
            const emptyState = $('#emptyState');
            const table = $('#documentsTable');

            if (filtered.length === 0) {
                table.addClass('d-none');
                emptyState.removeClass('d-none');
                return;
            }

            table.removeClass('d-none');
            emptyState.addClass('d-none');

            tbody.html(filtered.map(doc => `
                <tr>
                    <td>${escapeHtml(String(doc.id).substring(0, 8))}...</td>
                    <td>
                        <strong>${escapeHtml(doc.filename)}</strong>
                    </td>
                    <td>${doc.chunk_count || 0}</td>
                    <td>${formatDate(doc.upload_date)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="showDeleteModal('${escapeHtml(doc.id)}', '${escapeHtml(doc.filename)}', ${doc.chunk_count || 0})">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join(''));
        }

        function filterDocumentsList() {
            const search = $('#searchBox').val().toLowerCase().trim();
            if (!search) return documents;
            return documents.filter(doc =>
                (doc.filename && doc.filename.toLowerCase().includes(search)) ||
                (doc.id && String(doc.id).toLowerCase().includes(search))
            );
        }

        function filterDocuments() {
            renderDocuments();
        }

        // Delete functionality
        function showDeleteModal(docId, docName, chunkCount) {
            documentToDelete = docId;
            $('#deleteDocName').text(docName);
            $('#deleteChunkCount').text(chunkCount);
            deleteModal.show();
        }

        function confirmDelete() {
            if (!documentToDelete) return;

            $('#confirmDelete').prop('disabled', true).text('Deleting...');

            $.ajax({
                url: '/api/documents/' + encodeURIComponent(documentToDelete),
                method: 'DELETE',
                dataType: 'json',
                success: function(response) {
                    deleteModal.hide();
                    showToast('Document deleted successfully', 'success');
                    loadDocuments();
                },
                error: function() {
                    showToast('Failed to delete document', 'danger');
                },
                complete: function() {
                    $('#confirmDelete').prop('disabled', false).text('Delete Document');
                    documentToDelete = null;
                }
            });
        }

        // Utilities
        function showToast(message, type = 'success') {
            const toastEl = $('#toast');
            toastEl.removeClass('text-bg-success text-bg-danger text-bg-warning');
            toastEl.addClass('text-bg-' + type);
            $('#toastBody').text(message);
            toast.show();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
