<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Service Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-healthy { background: #e8f5e8; color: #27ae60; }
        .status-unhealthy { background: #ffeaea; color: #e74c3c; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: bold;
            color: #3498db;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            border: none;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            background: #ffeaea;
            color: #e74c3c;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è Database Service Dashboard</h1>
            <p>Monitor and manage your database service</p>
            <div id="connectionStatus" class="status-badge">Checking...</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">Overview</button>
            <button class="tab" onclick="switchTab('tables')">Tables</button>
            <button class="tab" onclick="switchTab('users')">Users</button>
            <button class="tab" onclick="switchTab('logs')">System Logs</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>üìä Database Status</h3>
                    <div class="metric">
                        <span>Connection Status</span>
                        <span id="dbStatus" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Database Version</span>
                        <span id="dbVersion" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Total Tables</span>
                        <span id="tableCount" class="metric-value">Loading...</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üîó Connection Pool</h3>
                    <div class="metric">
                        <span>Total Connections</span>
                        <span id="poolTotal" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Idle Connections</span>
                        <span id="poolIdle" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Waiting Count</span>
                        <span id="poolWaiting" class="metric-value">Loading...</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Statistics</h3>
                    <div class="metric">
                        <span>Users Count</span>
                        <span id="usersCount" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Documents Count</span>
                        <span id="documentsCount" class="metric-value">Loading...</span>
                    </div>
                    <div class="metric">
                        <span>Messages Count</span>
                        <span id="messagesCount" class="metric-value">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Tab -->
        <div id="tables" class="tab-content">
            <div class="table-container">
                <h3>üìã Database Tables</h3>
                <div id="tablesError" class="error" style="display: none;"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Table Name</th>
                            <th>Row Count</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tablesTableBody">
                        <tr>
                            <td colspan="4">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="table-container">
                <h3>üë• Users Management</h3>
                <button class="btn" onclick="loadUsers()">Refresh Users</button>
                <div id="usersError" class="error" style="display: none;"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>WhatsApp ID</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="table-container">
                <h3>üìú System Logs</h3>
                <button class="btn" onclick="loadSystemLogs()">Refresh Logs</button>
                <div id="logsError" class="error" style="display: none;"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Level</th>
                            <th>Message</th>
                            <th>Service</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr>
                            <td colspan="4">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshAll()" id="refreshBtn">üîÑ</button>

    <script>
        let currentTab = 'overview';

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            currentTab = tabName;

            // Load data for the active tab
            if (tabName === 'overview') {
                loadOverview();
            } else if (tabName === 'tables') {
                loadTables();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'logs') {
                loadSystemLogs();
            }
        }

        async function apiCall(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        async function loadOverview() {
            try {
                // Load health status
                const health = await apiCall('/health');
                document.getElementById('connectionStatus').textContent = health.status;
                document.getElementById('connectionStatus').className = 
                    `status-badge status-${health.status}`;

                // Load detailed status
                const status = await apiCall('/api/status');
                document.getElementById('dbStatus').textContent = 'Connected';
                document.getElementById('dbVersion').textContent = 
                    status.database_version ? status.database_version.split(' ')[0] : 'Unknown';
                document.getElementById('tableCount').textContent = status.table_count || 0;
                document.getElementById('poolTotal').textContent = status.pool_total_count || 0;
                document.getElementById('poolIdle').textContent = status.pool_idle_count || 0;
                document.getElementById('poolWaiting').textContent = status.pool_waiting_count || 0;

                // Load statistics
                await loadStatistics();

            } catch (error) {
                console.error('Failed to load overview:', error);
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('connectionStatus').className = 'status-badge status-unhealthy';
            }
        }

        async function loadStatistics() {
            try {
                const users = await apiCall('/api/user?limit=1');
                document.getElementById('usersCount').textContent = users.pagination?.total || 0;

                const documents = await apiCall('/api/document?limit=1');
                document.getElementById('documentsCount').textContent = documents.pagination?.total || 0;

                const messages = await apiCall('/api/message?limit=1');
                document.getElementById('messagesCount').textContent = messages.pagination?.total || 0;
            } catch (error) {
                console.error('Failed to load statistics:', error);
                document.getElementById('usersCount').textContent = 'Error';
                document.getElementById('documentsCount').textContent = 'Error';
                document.getElementById('messagesCount').textContent = 'Error';
            }
        }

        async function loadTables() {
            const tbody = document.getElementById('tablesTableBody');
            const errorDiv = document.getElementById('tablesError');
            
            try {
                errorDiv.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

                // This would need a custom endpoint to get table information
                // For now, showing common tables
                const commonTables = [
                    { name: 'users', estimated_rows: '?', size: '?' },
                    { name: 'documents', estimated_rows: '?', size: '?' },
                    { name: 'messages', estimated_rows: '?', size: '?' },
                    { name: 'conversations', estimated_rows: '?', size: '?' },
                    { name: 'document_chunks', estimated_rows: '?', size: '?' }
                ];

                tbody.innerHTML = commonTables.map(table => `
                    <tr>
                        <td>${table.name}</td>
                        <td>${table.estimated_rows}</td>
                        <td>${table.size}</td>
                        <td>
                            <button class="btn" onclick="viewTable('${table.name}')">View</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load tables:', error);
                errorDiv.textContent = `Error loading tables: ${error.message}`;
                errorDiv.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="4">Failed to load tables</td></tr>';
            }
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            const errorDiv = document.getElementById('usersError');
            
            try {
                errorDiv.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

                const response = await apiCall('/api/users?limit=20');
                const users = response.data || [];

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.whatsapp_id || 'N/A'}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn" onclick="viewUser('${user.id}')">View</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load users:', error);
                errorDiv.textContent = `Error loading users: ${error.message}`;
                errorDiv.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="5">Failed to load users</td></tr>';
            }
        }

        async function loadSystemLogs() {
            const tbody = document.getElementById('logsTableBody');
            const errorDiv = document.getElementById('logsError');
            
            try {
                errorDiv.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

                const response = await apiCall('/api/systemlog?limit=20');
                const logs = response.data || [];

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No logs found</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                        <td>${log.level || 'info'}</td>
                        <td>${log.message}</td>
                        <td>${log.service || 'database-service'}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load system logs:', error);
                errorDiv.textContent = `Error loading logs: ${error.message}`;
                errorDiv.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="4">Failed to load logs</td></tr>';
            }
        }

        function viewTable(tableName) {
            // This would open a modal or navigate to a detailed view
            alert(`View table: ${tableName}\n(Feature would be implemented to show table contents)`);
        }

        function viewUser(userId) {
            // This would open a modal or navigate to a detailed view
            alert(`View user: ${userId}\n(Feature would be implemented to show user details)`);
        }

        async function refreshAll() {
            const btn = document.getElementById('refreshBtn');
            btn.style.transform = 'rotate(360deg)';
            
            if (currentTab === 'overview') {
                await loadOverview();
            } else if (currentTab === 'tables') {
                await loadTables();
            } else if (currentTab === 'users') {
                await loadUsers();
            } else if (currentTab === 'logs') {
                await loadSystemLogs();
            }
            
            setTimeout(() => {
                btn.style.transform = 'rotate(0deg)';
            }, 500);
        }

        // Auto-refresh every 30 seconds for overview
        setInterval(() => {
            if (currentTab === 'overview') {
                loadOverview();
            }
        }, 30000);

        // Initial load
        loadOverview();
    </script>
</body>
</html>