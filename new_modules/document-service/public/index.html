<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Processing Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .document-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .document-item {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .document-item:last-child {
            border-bottom: none;
        }
        
        .document-info h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .document-meta {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .document-actions {
            display: flex;
            gap: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .file-drop-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-drop-zone:hover {
            background: #f0f4ff;
            border-color: #5a6fd8;
        }
        
        .file-drop-zone.dragover {
            background: #e8f0ff;
            border-color: #4c63d2;
        }
        
        .search-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .search-result {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .search-score {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Document Processing Service</h1>
            <p>Upload, process, and search through your documents</p>
        </div>
        
        <div class="content">
            <!-- Service Status Section -->
            <div class="section">
                <h2>üìä Service Status</h2>
                <div id="alertContainer"></div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDocuments">-</div>
                        <div class="stat-label">Total Documents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalChunks">-</div>
                        <div class="stat-label">Text Chunks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="embeddingModel">-</div>
                        <div class="stat-label">Embedding Model</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="dbStatus">-</div>
                        <div class="stat-label">Database Status</div>
                    </div>
                </div>
                <button class="btn" onclick="checkHealth()">
                    <span id="healthCheckBtn">üîÑ Check Status</span>
                </button>
            </div>
            
            <!-- Document Upload Section -->
            <div class="section">
                <h2>üì§ Upload Document</h2>
                <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div>
                        <h3>üìÅ Drop PDF file here or click to browse</h3>
                        <p>Supported format: PDF (Max size: 50MB)</p>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                <div id="uploadProgress" class="hidden" style="margin-top: 20px;">
                    <div style="background: #e9ecef; border-radius: 10px; overflow: hidden;">
                        <div id="progressBar" style="background: #667eea; height: 20px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="progressText" style="margin-top: 10px; text-align: center;">Processing...</p>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="section">
                <h2>üîç Search Documents</h2>
                <div class="form-group">
                    <label for="searchQuery">Search Query:</label>
                    <input type="text" id="searchQuery" placeholder="Enter your search query...">
                </div>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0; flex: 1;">
                        <label for="topK">Results Count:</label>
                        <input type="number" id="topK" value="3" min="1" max="10">
                    </div>
                    <div class="form-group" style="margin-bottom: 0; flex: 1;">
                        <label for="threshold">Similarity Threshold:</label>
                        <input type="number" id="threshold" value="0.0" min="0" max="1" step="0.1">
                    </div>
                </div>
                <button class="btn" onclick="searchDocuments()">üîç Search</button>
                <div id="searchResults"></div>
            </div>
            
            <!-- Document Management Section -->
            <div class="section">
                <h2>üìã Document Management</h2>
                <button class="btn" onclick="loadDocuments()">üîÑ Refresh List</button>
                <div id="documentList" class="document-list" style="margin-top: 20px;">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
            
            <!-- Configuration Section -->
            <div class="section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-group">
                    <label for="databaseUrl">Database URL:</label>
                    <input type="password" id="databaseUrl" placeholder="postgresql://user:pass@host:port/db">
                </div>
                <div class="form-group">
                    <label for="chunkSize">Text Chunk Size:</label>
                    <input type="number" id="chunkSize" value="500" min="100" max="2000">
                </div>
                <button class="btn" onclick="updateConfig()">üíæ Update Configuration</button>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let eventSource = null;
        let currentSessionId = null;
        
        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Connect to Server-Sent Events
        function connectSSE(sessionId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/events/${sessionId}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleProgressEvent(data);
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE error:', error);
            };
        }
        
        // Handle progress events
        function handleProgressEvent(data) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            switch (data.type) {
                case 'connected':
                    console.log('Connected to progress events');
                    break;
                    
                case 'progress':
                    progressDiv.classList.remove('hidden');
                    progressBar.style.width = data.progress + '%';
                    
                    let message = data.message;
                    if (data.current && data.total) {
                        message += ` (${data.current}/${data.total})`;
                    }
                    progressText.textContent = message;
                    break;
                    
                case 'completed':
                    progressBar.style.width = '100%';
                    progressText.textContent = data.message;
                    
                    if (data.chunks_created) {
                        showAlert(`Document processed successfully! Created ${data.chunks_created} text chunks in ${data.processing_time}ms.`, 'success');
                    } else {
                        showAlert(data.message, 'success');
                    }
                    
                    loadDocuments();
                    checkHealth();
                    
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                    }, 3000);
                    break;
                    
                case 'error':
                    showAlert('Processing failed: ' + data.message, 'error');
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }
                    }, 3000);
                    break;
            }
        }
        
        // Load initial configuration and status
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                config = await response.json();
                
                document.getElementById('chunkSize').value = config.chunk_size || 500;
                
                checkHealth();
                loadDocuments();
                
            } catch (error) {
                showAlert('Failed to load configuration: ' + error.message, 'error');
            }
        }
        
        // Check service health
        async function checkHealth() {
            const btn = document.getElementById('healthCheckBtn');
            btn.innerHTML = '<span class="loading"></span> Checking...';
            
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                document.getElementById('embeddingModel').textContent = 
                    health.embedding_model === 'loaded' ? '‚úÖ Loaded' : '‚ùå Not Loaded';
                document.getElementById('dbStatus').textContent = 
                    health.database_connection === 'active' ? '‚úÖ Active' : '‚ùå Inactive';
                
                // Load stats
                const statsResponse = await fetch('/stats');
                const stats = await statsResponse.json();
                
                document.getElementById('totalDocuments').textContent = stats.total_documents;
                document.getElementById('totalChunks').textContent = stats.total_chunks;
                
                showAlert('Service status updated successfully', 'success');
                
            } catch (error) {
                showAlert('Health check failed: ' + error.message, 'error');
            }
            
            btn.innerHTML = 'üîÑ Check Status';
        }
        
        // File upload handling
        function setupFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        async function handleFile(file) {
            if (file.type !== 'application/pdf') {
                showAlert('Please select a PDF file', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) { // 50MB
                showAlert('File size must be less than 50MB', 'error');
                return;
            }
            
            // Generate session ID and connect to SSE
            currentSessionId = generateSessionId();
            connectSSE(currentSessionId);
            
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '5%';
            progressText.textContent = 'Reading file...';
            
            try {
                // Convert file to base64
                const base64 = await fileToBase64(file);
                
                progressBar.style.width = '10%';
                progressText.textContent = 'Starting processing...';
                
                const response = await fetch('/process-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_data: base64,
                        filename: file.name,
                        session_id: currentSessionId
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Processing failed');
                }
                
            } catch (error) {
                showAlert('Upload failed: ' + error.message, 'error');
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    progressBar.style.width = '0%';
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                }, 3000);
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // Search documents
        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value.trim();
            const topK = parseInt(document.getElementById('topK').value);
            const threshold = parseFloat(document.getElementById('threshold').value);
            
            if (!query) {
                showAlert('Please enter a search query', 'error');
                return;
            }
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, top_k: topK, threshold })
                });
                
                const result = await response.json();
                
                if (result.results) {
                    displaySearchResults(result.results);
                    showAlert(`Found ${result.results.length} relevant results`, 'success');
                } else {
                    throw new Error(result.error || 'Search failed');
                }
                
            } catch (error) {
                showAlert('Search failed: ' + error.message, 'error');
            }
        }
        
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-results"><p>No results found.</p></div>';
                return;
            }
            
            const resultsHtml = results.map((result, index) => `
                <div class="search-result">
                    <div class="search-score">Score: ${result.score.toFixed(3)}</div>
                    <p>${result.text}</p>
                    <small>Document ID: ${result.document_id}, Chunk ID: ${result.chunk_id}</small>
                </div>
            `).join('');
            
            container.innerHTML = `<div class="search-results">${resultsHtml}</div>`;
        }
        
        // Load documents list
        async function loadDocuments() {
            try {
                console.log('Loading documents from server...');
                const response = await fetch('/documents');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Documents API response:', result);
                
                if (result.success === false) {
                    throw new Error(result.error || 'Failed to load documents');
                }
                
                const documents = result.documents || [];
                displayDocuments(documents);
                showAlert(`Loaded ${documents.length} documents successfully`, 'success');
                
            } catch (error) {
                console.error('Failed to load documents:', error);
                showAlert('Failed to load documents: ' + error.message, 'error');
                // Show empty state
                displayDocuments([]);
            }
        }
        
        function displayDocuments(documents) {
            const container = document.getElementById('documentList');
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="document-item"><p>No documents uploaded yet.</p></div>';
                return;
            }
            
            const documentsHtml = documents.map(doc => `
                <div class="document-item">
                    <div class="document-info">
                        <h4>${doc.filename}</h4>
                        <div class="document-meta">
                            Uploaded: ${new Date(doc.created_at).toLocaleString()} | 
                            ${doc.file_size} kb | 
                            ${doc.processed_content.length / 500 } chunks
                        </div>
                    </div>
                    <div class="document-actions">
                        <button type="button" class="btn btn-danger" onclick="deleteDocument('${doc.id}', '${doc.filename}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = documentsHtml;
        }
        
        // Delete document
        async function deleteDocument(id, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            console.log(`Starting deletion of document ${id} (${filename})`);
            
            // Generate session ID and connect to SSE for deletion progress
            const sessionId = generateSessionId();
            connectSSE(sessionId);
            
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '10%';
            progressText.textContent = 'Starting deletion...';
            
            try {
                console.log(`Making DELETE request to /documents/${id}`);
                const response = await fetch(`/documents/${id}?session_id=${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Delete response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Delete response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Delete failed');
                }
                
                // Success will be handled by SSE events
                console.log(`Successfully initiated deletion of ${filename}`);
                
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Delete failed: ' + error.message, 'error');
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    progressBar.style.width = '0%';
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                }, 3000);
            }
        }
        
        // Update configuration
        function updateConfig() {
            const dbUrl = document.getElementById('databaseUrl').value;
            const chunkSize = document.getElementById('chunkSize').value;
            
            showAlert('Configuration updated! Restart the service to apply changes.', 'success');
        }
        
        // Utility functions
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Initialize
        loadConfig();
        setupFileUpload();
    </script>
</body>
</html>